# EPC系统v3.6.5新功能说明

## 🆕 版本概述

基于v3.6.4的增强版本，新增了三个核心管理功能，实现了完整的数据管理和动态状态配置体系。

## 🎯 新增功能列表

### 1. 📥 数据导出功能

#### Dashboard端
- **位置**: Dashboard控制面板新增"📥 导出数据"按钮
- **功能**: 一键导出所有EPC记录为CSV文件
- **文件格式**: UTF-8编码的CSV，包含BOM标记，确保中文正确显示
- **文件命名**: `epc_data_YYYY-MM-DD.csv`

#### 导出字段
| 字段 | 说明 |
|------|------|
| ID | 记录唯一标识 |
| EPC ID | RFID标签ID |
| 设备ID | 上传设备标识 |
| 状态备注 | 操作状态 |
| 组装件ID | 关联组装件 |
| 创建时间 | 记录创建时间 |
| 上传时间 | 数据上传时间 |
| RSSI | 信号强度 |
| 设备类型 | 设备分类 |
| 位置 | 地理位置信息 |
| 应用版本 | 客户端版本 |

### 2. 🗑️ 数据清空功能

#### 安全机制
- **双重确认**: 两次弹窗确认，防止误操作
- **警告提示**: 明确告知不可恢复性
- **权限验证**: 需要Basic Auth认证

#### 执行过程
1. 清空主表数据 (`DELETE FROM epc_records_v364`)
2. 重置自增ID (`ALTER TABLE AUTO_INCREMENT = 1`)
3. 自动刷新Dashboard页面

#### API端点
```http
DELETE /api/epc-records/clear
Authorization: Basic cm9vdDpSb290cm9vdCE=
```

### 3. ⚙️ 状态配置管理

#### 管理界面
- **模态框设计**: 美观的弹出式配置界面
- **实时编辑**: 支持添加、删除、修改状态选项
- **即时预览**: 修改后立即显示效果

#### 默认状态配置
系统预设了6个建筑工业相关的状态：
1. **完成扫描录入** - 标准扫描操作
2. **构件录入** - 构件入库登记
3. **钢构车间进场** - 钢结构车间进入
4. **钢构车间出场** - 钢结构车间离开
5. **混凝土车间进场** - 混凝土车间进入
6. **混凝土车间出场** - 混凝土车间离开

#### 服务器端存储
- **配置文件**: `status-config.json`
- **持久化**: 自动保存配置更改
- **版本控制**: 包含更新时间戳

## 📱 Android应用增强

### 动态状态加载
- **启动加载**: 应用启动时自动从服务器获取最新状态配置
- **降级机制**: 网络失败时使用内置默认配置
- **实时更新**: 支持状态配置的动态切换

### 加载流程
```
1. 应用启动 → 2. 加载默认配置 → 3. 初始化UI → 
4. 请求服务器配置 → 5. 更新UI状态选项
```

### 错误处理
- 网络超时：使用默认配置
- 解析失败：回退到默认配置
- 服务器错误：记录日志并继续使用默认配置

## 🔧 API接口更新

### 新增端点

#### 获取状态配置
```http
GET /api/status-config
Authorization: Basic cm9vdDpSb290cm9vdCE=

Response:
{
  "success": true,
  "statuses": [
    "完成扫描录入",
    "构件录入",
    "钢构车间进场",
    "钢构车间出场",
    "混凝土车间进场",
    "混凝土车间出场"
  ],
  "timestamp": "2025-08-15T10:30:00.000Z"
}
```

#### 保存状态配置
```http
POST /api/status-config
Authorization: Basic cm9vdDpSb290cm9vdCE=
Content-Type: application/json

{
  "statuses": [
    "完成扫描录入",
    "构件录入",
    "钢构车间进场",
    "钢构车间出场",
    "混凝土车间进场",
    "混凝土车间出场"
  ]
}
```

#### 清空数据
```http
DELETE /api/epc-records/clear
Authorization: Basic cm9vdDpSb290cm9vdCE=

Response:
{
  "success": true,
  "message": "All EPC records have been cleared successfully",
  "timestamp": "2025-08-15T10:35:00.000Z"
}
```

## 🎨 UI界面优化

### Dashboard控制面板
- **新按钮布局**: 在刷新按钮旁增加三个功能按钮
- **颜色区分**: 
  - 导出数据：绿色渐变
  - 清空数据：红色渐变（危险操作）
  - 状态配置：黄色渐变（警告色）

### 状态配置模态框
- **响应式设计**: 适配不同屏幕尺寸
- **交互优化**: 
  - 状态项悬停效果
  - 删除按钮防误触
  - 保存/取消确认

### 成功/错误提示
- **位置**: 页面右上角浮动显示
- **自动消失**: 5秒后自动移除
- **视觉反馈**: 绿色成功，红色错误

## 🔄 工作流程示例

### 状态配置管理流程
1. **打开配置**: 点击"⚙️ 状态配置"按钮
2. **编辑状态**: 修改现有状态或添加新状态
3. **保存配置**: 点击"💾 保存配置"
4. **Android同步**: Android设备下次启动时自动获取新配置

### 数据管理流程
1. **数据导出**: 定期导出数据用于备份分析
2. **数据清空**: 在需要重新开始时清空历史数据
3. **状态调整**: 根据业务需求调整状态选项

## 📊 技术架构

### 前端架构
```
Dashboard (HTML/JS/CSS)
├── 导出功能 (CSV生成)
├── 清空功能 (确认对话框)
└── 状态配置 (模态框管理)
```

### 后端架构
```
Node.js Express Server
├── /api/epc-records/clear (DELETE)
├── /api/status-config (GET/POST)
└── status-config.json (配置存储)
```

### Android架构
```
EpcAssembleLinkFragment
├── 动态状态加载
├── 网络错误处理
└── UI自动更新
```

## 🛡️ 安全考虑

### 权限控制
- 所有管理功能都需要Basic Auth认证
- 清空数据操作有额外的确认机制
- 状态配置限制最大长度防止恶意输入

### 数据保护
- 导出功能不包含敏感信息
- 清空操作有详细的操作日志
- 状态配置自动备份

## 📈 性能优化

### 前端优化
- 异步加载状态配置，不阻塞UI初始化
- CSV导出使用内存友好的流式处理
- 模态框使用CSS硬件加速

### 后端优化
- 状态配置文件缓存，减少磁盘I/O
- 数据清空使用事务确保一致性
- API响应包含适当的缓存头

## 🔮 未来扩展

### 计划功能
1. **批量导入**: 支持CSV数据批量导入
2. **定时备份**: 自动定期导出数据
3. **角色权限**: 不同用户不同操作权限
4. **审计日志**: 记录所有管理操作

### 可扩展性
- 状态配置支持分组管理
- 导出格式支持Excel、PDF等
- 清空功能支持按条件清空

---

**版本**: v3.6.5  
**发布日期**: 2025-08-15  
**兼容性**: 向下兼容v3.6.4和之前版本  
**部署要求**: 需要重新部署服务器和Android应用